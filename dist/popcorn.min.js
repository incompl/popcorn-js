(function(global, document) {

  //  Cache refs to speed up calls to native utils
  var  
  forEach = Array.prototype.forEach, 
  hasOwn = Object.prototype.hasOwnProperty, 
  slice = Array.prototype.slice,

  //  ID string matching
  rIdExp  = /^(#([\w\-\_\.]+))$/, 
  
(function(o,l){var q=Array.prototype.forEach,s=Object.prototype.hasOwnProperty,t=Array.prototype.slice,u=/^(#([\w\-\_\.]+))$/,p=[],r=false,b=function(a){return new b.p.init(a)};b.p=b.prototype={init:function(a){var c;if(typeof a==="function")if(l.readyState==="interactive"||l.readyState==="complete")a(l,b);else{p.push(a);if(!r){r=true;var e=function(){l.removeEventListener("DOMContentLoaded",e,false);for(var f=0;f<p.length;f++)p[f].call(l,b);p=null};l.addEventListener("DOMContentLoaded",e,false)}}else{a=
u.exec(a);if(a.length&&a[2])c=l.getElementById(a[2]);this.video=c?c:null;this.data={history:[],events:{},trackEvents:{byStart:[{start:-1,end:-1}],byEnd:[{start:-1,end:-1}],startIndex:0,endIndex:0,previousUpdateTime:0}};var d=function(f){if(f.video.readyState>=3){var h=f.video.duration+1;b.addTrackEvent(f,{start:h,end:h});f.video.addEventListener("timeupdate",function(i){var j=this.currentTime,k=f.data.trackEvents.previousUpdateTime,g=f.data.trackEvents,m=g.byEnd,n=g.byStart;if(k<j){for(;m[g.endIndex]&&
m[g.endIndex].end<=j;){if(m[g.endIndex]._running===true){m[g.endIndex]._running=false;m[g.endIndex]._natives.end.call(f,i,m[g.endIndex])}g.endIndex++}for(;n[g.startIndex]&&n[g.startIndex].start<=j;){if(n[g.startIndex].end>j&&n[g.startIndex]._running===false){n[g.startIndex]._running=true;n[g.startIndex]._natives.start.call(f,i,n[g.startIndex])}g.startIndex++}}else if(k>j){for(;n[g.startIndex]&&n[g.startIndex].start>j;){if(n[g.startIndex]._running===true){n[g.startIndex]._running=false;n[g.startIndex]._natives.end.call(f,
i,n[g.startIndex])}g.startIndex--}for(;m[g.endIndex]&&m[g.endIndex].end>j;){if(m[g.endIndex].start<=j&&m[g.endIndex]._running===false){m[g.endIndex]._running=true;m[g.endIndex]._natives.start.call(f,i,m[g.endIndex])}g.endIndex--}}g.previousUpdateTime=j},false)}else o.setTimeout(function(){d(f)},1)};d(this);return this}}};b.p.init.prototype=b.p;b.forEach=function(a,c,e){if(!a||!c)return{};e=e||this;if(q&&a.forEach===q)return a.forEach(c,e);for(var d in a)s.call(a,d)&&c.call(e,a[d],d,a);return a};b.extend=
function(a){var c=t.call(arguments,1);b.forEach(c,function(e){for(var d in e)a[d]=e[d]});return a};b.extend(b,{error:function(a){throw a;},guid:function(a){b.guid.counter++;return(a?a:"")+(+new Date+b.guid.counter)},sizeOf:function(a){var c=0,e;for(e in a)c++;return c},nop:function(){}});b.guid.counter=1;b.extend(b.p,function(){var a={};b.forEach("load play pause currentTime playbackRate mute volume duration".split(/\s+/g),function(c){a[c]=function(e){if(typeof this.video[c]==="function"){this.video[c]();
return this}if(e!==false&&e!==null&&typeof e!=="undefined"){this.video[c]=e;return this}return this.video[c]}});return a}());b.extend(b.p,{roundTime:function(){return-~this.video.currentTime},exec:function(a,c){!c&&(c=b.nop);var e=this,d=b.guid("execCallback"),f=function(h){if(this.currentTime()>=a&&!f.fired){f.fired=true;this.unlisten("timeupdate",d);c.call(e,h)}};f.fired=false;f.name=d;this.listen("timeupdate",f);return this},removePlugin:function(a){var c=this.data.trackEvents.byStart,e=this.data.trackEvents.byEnd;
delete b.p[a];for(var d=0,f=b.registry.length;d<f;d++)if(b.registry[d].type===a){b.registry.splice(d,1);break}d=0;for(f=c.length;d<f;d++)if(c[d]&&c[d]._natives&&c[d]._natives.type===a){c.splice(d,1);d--;f--;this.data.trackEvents.startIndex<=d&&this.data.trackEvents.startIndex--}c=0;for(d=e.length;c<d;c++)if(e[c]&&e[c]._natives&&e[c]._natives.type===a){e.splice(c,1);c--;d--;this.data.trackEvents.endIndex<=c&&this.data.trackEvents.endIndex--}return this}});b.Events={UIEvents:"blur focus focusin focusout load resize scroll unload  ",
MouseEvents:"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave click dblclick",Events:"loadstart progress suspend emptied stalled play pause loadedmetadata loadeddata waiting playing canplay canplaythrough seeking seeked timeupdate ended ratechange durationchange volumechange"};b.Events.Natives=b.Events.UIEvents+" "+b.Events.MouseEvents+" "+b.Events.Events;b.events={isNative:function(a){for(var c=b.Events.Natives.split(/\s+/g),e=0;e<c.length;e++)if(c[e]===a)return true;return false},
getInterface:function(a){if(!b.events.isNative(a))return false;var c=b.Events,e,d;for(d in c)if(d!=="Natives"&&c[d].indexOf(a)>-1)e=d;return e},all:b.Events.Natives.split(/\s+/g),fn:{trigger:function(a,c){if(this.data.events[a]&&b.sizeOf(this.data.events[a])){var e=b.events.getInterface(a);if(e){e=l.createEvent(e);e.initEvent(a,true,true,o,1);this.video.dispatchEvent(e);return this}b.forEach(this.data.events[a],function(d){d.call(this,c)},this)}return this},listen:function(a,c){var e=this,d=true;
if(!this.data.events[a]){this.data.events[a]={};d=false}this.data.events[a][c.name||c.toString()+b.guid()]=c;!d&&b.events.all.indexOf(a)>-1&&this.video.addEventListener(a,function(f){b.forEach(e.data.events[a],function(h){typeof h==="function"&&h.call(e,f)})},false);return this},unlisten:function(a,c){if(this.data.events[a]&&this.data.events[a][c]){delete this.data.events[a][c];return this}this.data.events[a]=null;return this},special:{play:function(){}}}};b.forEach(["trigger","listen","unlisten"],
function(a){b.p[a]=b.events.fn[a]});b.protect={natives:"load play pause currentTime playbackRate mute volume duration removePlugin roundTime trigger listen unlisten".toLowerCase().split(/\s+/)};b.addTrackEvent=function(a,c){if(c._natives){c._id=!c.id?b.guid(c._natives.type):c.id;a.data.history.push(c._id)}a.data.trackEvents.byStart.push(c);a.data.trackEvents.byEnd.push(c);a.data.trackEvents.byStart.sort(function(e,d){return e.start-d.start});a.data.trackEvents.byEnd.sort(function(e,d){return e.end-
d.end})};b.removeTrackEvent=function(a,c){var e=a.data.history.length,d=0,f=[],h=[],i=[];b.forEach(a.data.trackEvents.byStart,function(k,g){if(!k._id){f.push(a.data.trackEvents.byStart[g]);h.push(a.data.trackEvents.byEnd[g])}if(k._id){if(k._id!==c){f.push(a.data.trackEvents.byStart[g]);h.push(a.data.trackEvents.byEnd[g])}if(k._id===c)d=g}});d<=a.data.trackEvents.startIndex&&a.data.trackEvents.startIndex--;d<=a.data.trackEvents.endIndex&&a.data.trackEvents.endIndex--;a.data.trackEvents.byStart=f;a.data.trackEvents.byEnd=
h;for(var j=0;j<e;j++)a.data.history[j]!==c&&i.push(a.data.history[j]);a.data.history=i};b.getTrackEvents=function(a){var c=[];b.forEach(a.data.trackEvents.byStart,function(e){e._id&&c.push(e)});return c};b.getLastTrackEventId=function(a){return a.data.history[a.data.history.length-1]};b.extend(b.p,{getTrackEvents:function(){return b.getTrackEvents.call(null,this)},getLastTrackEventId:function(){return b.getLastTrackEventId.call(null,this)},removeTrackEvent:function(a){b.removeTrackEvent.call(null,
this,a);return this}});b.manifest={};b.registry=[];b.plugin=function(a,c){if(b.protect.natives.indexOf(a.toLowerCase())>=0)b.error("'"+a+"' is a protected function name");else{var e=["start","end"],d={type:a},f,h;if(typeof c==="object"){h=c;f=function(i){if(!i)return this;i._natives=h;i._natives.type=a;i._running=false;if(!("start"in i))i.start=0;if(!("end"in i))i.end=this.duration();if("_setup"in h&&typeof h._setup==="function"){i.target||h.manifest.options.target&&(i.target=h.manifest.options.target);
h._setup.call(this,i)}b.addTrackEvent(this,i);b.forEach(h,function(j,k){k!=="type"&&e.indexOf(k)===-1&&this.listen(k,j)},this);return this}}if(typeof c==="function"){h=c.call(this);typeof h==="object"&&!("length"in h)&&b.plugin(a,h)}else{d[a]=f;b.extend(b.p,d);b.registry.push(d);if("manifest"in h)b.manifest[a]=h.manifest;return d}}};b.parsers={};b.parser=function(a,c,e){if(b.protect.natives.indexOf(a.toLowerCase())>=0)b.error("'"+a+"' is a protected function name");else if(typeof e==="function"){var d=
{};d[a]=function(f){if(!f)return this;var h=this;b.xhr({url:f,success:function(i){i=e(i);for(var j=0,k=i.data.length;j<k;j++)for(var g in i.data[j])i.data[j].hasOwnProperty(g)&&h[g](i.data[j][g])}});return this};b.extend(b.p,d);b.parsers[c]=a;return d}};var v=/\?/,w={url:"",data:"",dataType:"",success:b.nop,type:"GET",async:true,xhr:function(){return new o.XMLHttpRequest}};b.xhr=function(a){if((a.dataType||"").toLowerCase()==="jsonp")b.xhr.getJSONP(a.url,a.success);else{a=b.extend({},w,a);a.ajax=
a.xhr();if(a.ajax){if(a.type==="GET"&&a.data){a.url+=(v.test(a.url)?"&":"?")+a.data;a.data=null}a.ajax.open(a.type,a.url,a.async);a.ajax.send(a.data=a.data);return b.xhr.httpData(a)}}};b.xhr.httpData=function(a){var c,e=null;a.ajax.onreadystatechange=function(){if(a.ajax.readyState===4){try{e=JSON.parse(a.ajax.responseText)}catch(d){}c={xml:a.ajax.responseXML,text:a.ajax.responseText,json:e};a.success.call(a.ajax,c)}};return c};b.xhr.getJSONP=function(a,c){var e=l.getElementsByTagName("head")[0]||
l.documentElement,d=l.createElement("script"),f=a.split("?")[1],h=false,i;d.src=a;f=f.split("&");if(i=f.length?f[f.length-1].split("=")[1]:b.guid("jsonp"))window[i]=function(j){c(j);h=true};d.onload=d.onreadystatechange=function(){if(h||this.readyState==="loaded"||this.readyState==="complete"){delete window[i];e.removeChild(d)}};e.insertBefore(d,e.firstChild)};o.Popcorn=b;l.addEventListener("DOMContentLoaded",function(){var a=l.getElementsByTagName("video");b.forEach(a,function(c,e){var d=a[e],f,
h,i,j,k;if(d.nodeType&&d.nodeType===1&&d.id){k=b("#"+d.id);f=(d.getAttribute("data-timeline-sources")||"").split(",");f.length&&b.forEach(f,function(g){h=g.split(":");i=h[0];if(h.length===1){h=g.split(".");i=h[h.length-1]}i=i.toUpperCase();j="parse"+i;f&&b.parsers[i]&&k[j](g)});k.autoplay&&k.play()}})},false)})(window,window.document);
